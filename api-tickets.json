<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Tickets - Sortia</title>
</head>
<body>
    <script>
        // Configuración (misma que en main.js)
        const CONFIG = {
            totalTickets: 1000,
            googleSheets: {
                sheetId: '11AJDOkCz9hdMGI0LHaub41qWxwOSXBx_zXaeW-Fdp5s',
                sheetName: 'Hoja 1',
                method: 'api',
                options: {
                    apiKey: 'AIzaSyBTg5ozE85sC1Qvw2ZbxnTW5Jxnn0cL4iE',
                    range: 'D2:D1001',
                    ticketsRange: 'A2:D1001'
                }
            }
        };

        // Clase simplificada para leer Google Sheets
        class GoogleSheetsReader {
            constructor(sheetId, sheetName) {
                this.sheetId = sheetId;
                this.sheetName = sheetName;
            }

            async fetchData(method, options) {
                const { apiKey, ticketsRange } = options;
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${this.sheetName}!${ticketsRange}?key=${apiKey}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Error al leer Google Sheets');
                
                const data = await response.json();
                return this.parseResponse(data);
            }

            parseResponse(data) {
                if (!data.values || data.values.length === 0) return { rows: [] };
                
                // Leer número de ticket y estado
                const rows = data.values.map((row, index) => {
                    const ticketNumber = row[0] !== undefined && row[0] !== '' && !isNaN(Number(row[0]))
                        ? Number(row[0])
                        : index; // Si no hay número, usar el índice
                    
                    return {
                        numero: ticketNumber,
                        estado: (row[3] || '').trim()
                    };
                });

                return { rows };
            }
        }

        // Función para formatear lista de números de manera eficiente
        function formatNumberList(numbers) {
            // Ordenar números
            const sorted = [...numbers].sort((a, b) => a - b);
            
            // Formato compacto: "0,1,2,3,4,5" o rangos "0-5,10,15-20"
            // Por simplicidad, usar formato de lista separada por comas
            return sorted.join(',');
        }

        // Función para obtener JSON (para n8n)
        async function getJSONData() {
            try {
                const reader = new GoogleSheetsReader(
                    CONFIG.googleSheets.sheetId,
                    CONFIG.googleSheets.sheetName
                );

                const data = await reader.fetchData(
                    CONFIG.googleSheets.method,
                    CONFIG.googleSheets.options
                );

                // Separar tickets disponibles y ocupados
                const disponibles = [];
                const ocupados = [];
                
                data.rows.forEach(row => {
                    const estado = (row.estado || 'disponible').toLowerCase().trim();
                    const numero = row.numero;
                    
                    if (estado === 'disponible') {
                        disponibles.push(numero);
                    } else {
                        // Considerar ocupado: ocupado, ocupada, vendido, vendida, reservado, reservada
                        ocupados.push(numero);
                    }
                });

                const totalOcupados = ocupados.length;
                const totalDisponibles = disponibles.length;
                const now = new Date();

                // Decidir qué lista incluir (optimización de tokens)
                // Si hay menos de 500 ocupados, listar ocupados
                // Si hay 500 o más ocupados, listar disponibles
                const incluirOcupados = totalOcupados < 500;
                
                const jsonData = {
                    fecha: now.toISOString(),
                    fecha_formateada: now.toLocaleString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        timeZone: 'Europe/Madrid'
                    }),
                    tickets_disponibles: totalDisponibles,
                    tickets_totales: CONFIG.totalTickets,
                    tickets_ocupados: totalOcupados,
                    timestamp: Math.floor(now.getTime() / 1000)
                };

                // Agregar lista según corresponda (solo números, sin texto adicional)
                if (incluirOcupados) {
                    jsonData.numeros_ocupados = formatNumberList(ocupados);
                    jsonData.lista_tipo = 'ocupados';
                } else {
                    jsonData.numeros_disponibles = formatNumberList(disponibles);
                    jsonData.lista_tipo = 'disponibles';
                }

                // Devolver JSON
                document.body.textContent = JSON.stringify(jsonData, null, 2);
                document.body.style.fontFamily = 'monospace';
                document.body.style.padding = '20px';
                document.body.style.whiteSpace = 'pre';
            } catch (error) {
                document.body.textContent = JSON.stringify({ 
                    error: error.message,
                    fecha: new Date().toISOString()
                }, null, 2);
                document.body.style.fontFamily = 'monospace';
                document.body.style.padding = '20px';
                document.body.style.whiteSpace = 'pre';
            }
        }

        // Ejecutar al cargar
        getJSONData();
    </script>
</body>
</html>

